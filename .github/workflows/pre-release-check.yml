name: Pre-release Check

on:
  push:
    branches:
      - 'release/**'
      - 'pre-release/**'
      - 'alpha/**'
      - 'beta/**'

jobs:
  build-check:
    name: Build Check ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64 build
          - os: ubuntu-24.04
            platform: linux
            arch: amd64
            ext: ''
          # Linux ARM64 build - using native ARM64 runner
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
            ext: ''
          # Windows AMD64 build
          - os: windows-latest
            platform: windows
            arch: amd64
            ext: '.exe'
          # Windows ARM64 build - using native ARM64 runner
          - os: windows-11-arm
            platform: windows
            arch: arm64
            ext: '.exe'
          # macOS Universal build (includes both Intel and Apple Silicon)
          - os: macos-latest
            platform: darwin
            arch: universal
            ext: '.app'

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Linux dependencies (AMD64)
        if: matrix.platform == 'linux' && matrix.arch == 'amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            gcc \
            pkg-config \
            wget \
            file

          # Verify webkit2gtk-4.1 is properly installed
          pkg-config --modversion webkit2gtk-4.1 || exit 1
          echo "webkit2gtk-4.1 installed successfully"

          # Create symlink for Wails v2 compatibility (looks for 4.0)
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          echo "Created webkit2gtk-4.0 symlink for Wails compatibility"

      - name: Install Linux dependencies (ARM64)
        if: matrix.platform == 'linux' && matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            gcc \
            pkg-config \
            wget \
            file

          # Verify webkit2gtk-4.1 is properly installed
          pkg-config --modversion webkit2gtk-4.1 || exit 1
          echo "webkit2gtk-4.1 installed successfully for ARM64"

          # Create symlink for Wails v2 compatibility (looks for 4.0)
          sudo ln -sf /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          echo "Created webkit2gtk-4.0 symlink for Wails compatibility"

      - name: Install Windows dependencies (AMD64)
        if: matrix.platform == 'windows' && matrix.arch == 'amd64'
        run: |
          choco install mingw nsis -y
        shell: pwsh

      - name: Install Windows dependencies (ARM64)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        run: |
          choco install mingw nsis -y
          # MinGW is required for systray (CGO)
        shell: pwsh

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Strip tray dependencies for macOS build
        if: matrix.platform == 'darwin'
        run: |
          # Remove systray-specific sources and dependency for macOS release builds
          rm -f internal/tray/manager_systray.go

          # Provide a temporary darwin-only stub so the tray package still builds
          cat > internal/tray/manager_macos_ci_stub.go <<'EOF'
          //go:build darwin

          package tray

          import "context"

          type Manager struct{}

          func NewManager(_ interface{}, _ []byte) *Manager { return &Manager{} }
          func (m *Manager) Start(_ context.Context, _ func(), _ func()) {}
          func (m *Manager) Stop() {}
          func (m *Manager) IsRunning() bool { return false }
          EOF

          go mod edit -droprequire github.com/getlantern/systray
          go mod tidy

      - name: Build frontend (required for embed)
        working-directory: ./frontend
        run: npm run build

      - name: Build application (Linux)
        if: matrix.platform == 'linux'
        env:
          CGO_ENABLED: 1
        run: |
          wails build -clean -ldflags "-s -w" -platform ${{ matrix.platform }}/${{ matrix.arch }}

          # Verify the build
          if [ ! -f "build/bin/MrRSS" ]; then
            echo "Error: Binary not found"
            exit 1
          fi

          # Check architecture
          file build/bin/MrRSS
          echo "Binary built successfully for ${{ matrix.arch }}"

      - name: Build application (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          CGO_ENABLED: 1
        run: |
          wails build -clean -ldflags "-s -w" -platform ${{ matrix.platform }}/${{ matrix.arch }}

          # Verify the build
          if (-not (Test-Path "build/bin/MrRSS.exe")) {
            Write-Error "Binary not created"
            exit 1
          }

          Write-Host "Binary built successfully for ${{ matrix.arch }}"

      - name: Build application (macOS)
        if: matrix.platform == 'darwin'
        run: |
          # macOS runners can build universal binaries natively
          # Universal binaries include both Intel (amd64) and Apple Silicon (arm64)
          wails build -clean -ldflags "-s -w" -platform ${{ matrix.platform }}/${{ matrix.arch }}

      - name: Create installer (Windows)
        if: matrix.platform == 'windows'
        run: |
          # Find NSIS installation
          $nsisPath = Get-Command makensis -ErrorAction SilentlyContinue
          if (-not $nsisPath) {
            # Try common installation paths
            $possiblePaths = @(
              "C:\Program Files (x86)\NSIS\makensis.exe",
              "C:\Program Files\NSIS\makensis.exe"
            )
            foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                $nsisPath = $path
                break
              }
            }
          } else {
            $nsisPath = $nsisPath.Source
          }

          if (-not $nsisPath) {
            Write-Error "NSIS not found"
            exit 1
          }

          Write-Host "Using NSIS at: $nsisPath"

          # Get version from wails.json
          $wailsJson = Get-Content "wails.json" -Raw | ConvertFrom-Json
          $version = $wailsJson.info.productVersion
          $arch = "${{ matrix.arch }}"
          $installerPath = "build/windows/installer.nsi"

          if (Test-Path $installerPath) {
            $content = Get-Content $installerPath -Raw
            $content = $content -replace '!define APP_VERSION ".*"', "!define APP_VERSION `"$version`""
            $content = $content -replace 'OutFile ".*"', "OutFile `"..\bin\MrRSS-$version-windows-$arch-installer.exe`""
            Set-Content $installerPath $content

            # Build NSIS installer
            & $nsisPath $installerPath

            if ($LASTEXITCODE -ne 0) {
              Write-Error "NSIS build failed with exit code $LASTEXITCODE"
              exit 1
            }
          } else {
            Write-Warning "Installer script not found at $installerPath"
            exit 1
          }
        shell: pwsh
        continue-on-error: true

      - name: Create installer (Linux)
        if: matrix.platform == 'linux'
        run: |
          # Clean up any cached appimagetool to ensure correct architecture is downloaded
          rm -f build/appimagetool-*.AppImage

          chmod +x build/linux/create-appimage.sh
          ARCH=${{ matrix.arch }} ./build/linux/create-appimage.sh || echo "AppImage creation failed, will use tar.gz"
        continue-on-error: true

      - name: Create installer (macOS)
        if: matrix.platform == 'darwin'
        run: |
          chmod +x build/macos/create-dmg.sh
          ./build/macos/create-dmg.sh
        continue-on-error: true

      - name: Package application (Linux - tar.gz fallback)
        if: matrix.platform == 'linux'
        run: |
          cd build/bin
          if [ -f "MrRSS" ]; then
            # Get version from wails.json
            VERSION=$(jq -r '.info.productVersion' ../../wails.json)
            tar -czf MrRSS-${VERSION}-linux-${{ matrix.arch }}.tar.gz MrRSS
            echo "Created tar.gz package"
          else
            echo "Error: MrRSS binary not found"
            exit 1
          fi

      - name: Verify build artifacts
        shell: bash
        run: |
          echo "Build verification for ${{ matrix.platform }}-${{ matrix.arch }}"
          echo "Checking build/bin directory..."
          ls -lh build/bin/ || echo "No artifacts found"
          echo "Build check completed successfully"
